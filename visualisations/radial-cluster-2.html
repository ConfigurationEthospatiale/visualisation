<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Radial tree</title>
  <link rel="stylesheet" href="../node_modules/shepherd.js/dist/css/shepherd.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>

</head>

<body>

  <h1 class="titleClasse">TItrle </h1>
  <svg id="radial-tree" width="900"></svg>
  <p class="first">asfhcéohcaoméehfsci</p>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@8.6.0/dist/css/shepherd.css" />
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.6.0/dist/js/shepherd.min.js"></script>

  <script>
    const tour = new Shepherd.Tour({
      defaults: {
        classes: 'shepherd'
      }
    });

    tour.addStep({
      id: 'example-step',
      text: 'This step is attached to the bottom of the <code>.example-css-selector</code> element.',
      attachTo: {
        element: '.titleClasse',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Next',
          action: tour.next
        }
      ]
    });
    tour.start()
  </script>

  <script>


    const CouleursEthos = {
      cosmopolite: "#E2B4BD",
      "d'opposition": "#93A8AC",
      "de genre": "#B88D00",
      "environnemental": "#700353",
      "de la migrance": "#3E5622",
      "de la présence": "#DB7F67",
      "mémoriel": "#345995"
    };


    const width = 1000;
    const height = width;
    const cx = width * 0.5;
    const cy = height * 0.52;
    const radius = Math.min(width, height) / 2 - 200;

    const svg = d3.select("#radial-tree")
      .attr("viewBox", [-cx, -cy, width, height])
      .style("font", "10px sans-serif")
      .style("user-select", "none");


    const tree = d3.tree()
      .size([2 * Math.PI, radius])
      .separation(() => 1);

    // CSV
    d3.text("../data/titre_ethos.csv").then(csvText => {
      const lines = csvText.trim().split("\n");
      const entries = lines.map(line => {
        const [book, ethosRaw] = line.split(";").map(d => d.trim());
        const ethos = ethosRaw.replace("Ethos ", "");
        return { book, ethos };
      });
      console.log(entries)
      const grouped = d3.group(entries, d => d.ethos);

      const data = {
        name: "ethos",
        children: Array.from(grouped, ([ethos, books]) => ({
          name: ethos,
          children: books.map(b => ({ name: b.book }))
        }))
      };


      const root = tree(d3.hierarchy(data));
      const links = root.links();
      var nodes = root.descendants();

      nodes.forEach(d => {
        if (!d.children && d.parent) {
          d.color = CouleursEthos[d.parent.data.name];
        } else if (CouleursEthos[d.data.name]) {
          d.color = CouleursEthos[d.data.name];
        } else {
          d.color = "#ccc";
        }
      });

      // Links
      svg.append("g")
        .attr("fill", "none")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", 1.5)
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("d", d3.linkRadial()
          .angle(d => d.x)
          .radius(d => d.y))
        .attr("stroke", d => (d.target && d.target.color) ? d.target.color : "#ccc");


      // Nodes
      svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("transform", d => `
      rotate(${d.x * 180 / Math.PI - 90})
      translate(${d.y},0)
    `)
        .attr("r", 2.5)
        .attr("fill", d => d.color || "#999");

      // Labels
      svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .attr("transform", d => `
      rotate(${d.x * 180 / Math.PI - 90})
      translate(${d.y},0)
      rotate(${d.x >= Math.PI ? 180 : 0})
    `)
        .attr("dy", "0.31em")
        .attr("x", d => d.x < Math.PI === !d.children ? 6 : -6)
        .attr("text-anchor", d => d.x < Math.PI === !d.children ? "start" : "end")
        .text(d => d.data.name)
        .style("fill", d => d.color || "black")
        .clone(true).lower()
        .attr("stroke", "white");
    });
    tour.start()

  </script>

</body>

</html>