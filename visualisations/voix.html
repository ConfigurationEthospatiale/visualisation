<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body { font: 12px sans-serif; }
  .line {
    fill: none;
    stroke-opacity: 0.3;
  }
  .line.selected {
    stroke-opacity: 1;
  }

</style>

<body>
  <svg width="800" height="500"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    let selectedLabel = null;
    let selectedType = null; // "ethos" or "pronoun"
    const ethosColors = {
        "Ethos cosmopolite": "#E2B4BD",
        "Ethos d'opposition": "#93A8AC",
        "Ethos de genre": "#B88D00",
        "Ethos environnemental": "#700353",
        "Ethos de la migrance": "#3E5622",
        "Ethos de la présence": "#DB7F67",
        "Ethos mémoriel": "#345995"
        };

    
    d3.dsv(";", "../data/voix-ethos.csv").then(raw => {
        
        const expandedData = raw.flatMap(row => {
        const ethos = row["Ethos d'opposition"]?.trim() || row["Ethos de genre"]?.trim() || row["Ethos de la migrance"]?.trim() || row["Ethos cosmopolite"]?.trim() || row["Ethos"]?.trim();
        const rawPronouns = row["Il"] || row["Pronoun"];
        if (!ethos || !rawPronouns) return [];
        return rawPronouns
          .split(";")
          .map(p => p.trim().toUpperCase())
          .filter(p => p)
          .map(pronoun => ({ ethos, pronoun }));
        });
        
        const ethosValues = Array.from(new Set(expandedData.map(d => d.ethos)));
        const orderedPronouns = ["JE", "TU", "IL", "ELLE", "ILS", "ELLES", "NOUS", "VOUS"];

        const pairCounts = d3.rollup(
            expandedData,
            v => v.length,
            d => d.ethos,
            d => d.pronoun
        );
            
        const aggregatedData = Array.from(pairCounts, ([ethos, pronounMap]) =>
            Array.from(pronounMap, ([pronoun, count]) => ({ ethos, pronoun, count }))
        ).flat();

        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const margin = { top: 20, bottom: 20, left: 200, right: 200 };

        const yEthos = d3.scalePoint()
            .domain(ethosValues)
            .range([margin.top, height - margin.bottom]);

        const yPronoun = d3.scalePoint()
            .domain(orderedPronouns)
            .range([margin.top, height - margin.bottom]);

        const xPos = {
            ethos: margin.left,
            pronoun: width - margin.right,
        };

        const widthScale = d3.scaleLinear()
            .domain([1, d3.max(aggregatedData, d => d.count)])
            .range([1, 6]);


        const lines = svg.append("g")
            .selectAll("path")
            .data(aggregatedData)
            .join("path")
            .attr("class", "line")
            .attr("d", d => `
                M${xPos.ethos},${yEthos(d.ethos)}
                L${xPos.pronoun},${yPronoun(d.pronoun)}
            `)
            .attr("stroke", d => ethosColors[d.ethos] || "#999") // fallback color if unknown
            .attr("stroke-width", d => widthScale(d.count));

        function updateLineColors() {
            lines.classed("selected", d => {
            if (!selectedLabel) return false;
            return selectedType === "ethos"
                ? d.ethos === selectedLabel
                : d.pronoun === selectedLabel;
            });
        }


      // Labels: ETHOS
        svg.selectAll(".labelEthos")
            .data(ethosValues)
            .join("text")
            .attr("class", "labelEthos")
            .attr("x", xPos.ethos - 10)
            .attr("y", d => yEthos(d))
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "middle")
            .style("cursor", "pointer")
            .style("fill", d => ethosColors[d] || "#000")  .text(d => d)
            .on("click", function(event, d) {
                if (selectedLabel === d && selectedType === "ethos") {
                selectedLabel = null;
                selectedType = null;
                } else {
                selectedLabel = d;
                selectedType = "ethos";
                }
                updateLineColors();
            });


      // Labels: PRONOUNS
        svg.selectAll(".labelPronoun")
            .data(orderedPronouns)
            .join("text")
            .attr("class", "labelPronoun")
            .attr("x", xPos.pronoun + 10)
            .attr("y", d => yPronoun(d))
            .attr("text-anchor", "start")
            .attr("alignment-baseline", "middle")
            .style("cursor", "pointer")
            .text(d => d)
            .on("click", function(event, d) {
            if (selectedLabel === d && selectedType === "pronoun") {
                selectedLabel = null;
                selectedType = null;
            } else {
                selectedLabel = d;
                selectedType = "pronoun";
            }
            updateLineColors();
            });
        });
  </script>
</body>
